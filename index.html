<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>A Decade of Terrorism</title>

    <link href="http://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

    <style>
    h1,h2 {
            position: absolute;
            left: 20px;
            top: 10px;
            font-weight: 100;
            color: #005DAA;
        }
        h1{
            font-size: 2em;
        }
        h2 {
            font-size: 1.5em;
            font-style: italic;
            top: 85px;
        }
        h3 {
            font-size: 1.5em;
            bottom: 50px;
        }
        p {
            position: absolute;
            left: 20px;
            top: 150px;
            font-size: 15px;
            color: #005DAA;
        }
        p2 {
            position: absolute;
            left: 20px;
            bottom: 20px;
            font-size: 12px;
        }
        #map {
            width: 900px;
            height: 625px;
            margin: 25px 245px auto;
            border: 2px solid #fff;
        }
        body {
            padding: 0;
            margin: 0;
            background: #d3d3d3;
            font-family: Raleway, sans-serif;
        }
        .countries {
            stroke: #5a4a4a;
        }
        .hover{
            fill: #005DAA;
        }
        .slider {
            position: absolute;
            left: 245px;
            bottom: 40px;
        }
        #year {
            position: relative;
            /*left: 285px;*/
            padding-top: 5px;
        }
        .attack {
            fill: yellow;
            fill-opacity: .3;
        }
    </style>
</head>

<body>



    <div id='sidebar'>
        <h1>A Decade of<br> Terrorism</h1>
        <p> The map to the right consists<br> of a base map shaded by the<br> % of GDP spent on defense<br> by each nation. The GDP<br> data was obtained from
        <a href src="http://data.worldbank.org/indicator/MS.MIL.XPND.GD.ZS"><br> The World
        Bank</a>. Nation<br> states that are shaded black<br> either do not spend any<br> portion of their GDP towards<br> defense or the data is not<br> available.<br> The yellow dots<br> represent terrorist attacks <br>that have taken place around<br> the world since
        1996-2006.<br> The slider bar allows the user<br> to cycle through the attacks<br> by year. The <a href src="http://www.start.umd.edu/gtd/contact/">Global Terrorism<br>
        Database</a> is maintained by<br> the University of Maryland.<br> Please see the <a href src="http://www.start.umd.edu/gtd/using-gtd/">methodology<br> page</a> for a detailed explanation<br> of the data and how it was<br> collected.
        </p>
        <p2>Map Authored by: Francisco Lovko For: Map673</p2>
    </div>
    <div id="map">
    <h2></h2>
      <div id="slider">
            <input type="range" value="0" class="slider">
            <span id="year"></span>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/0.9.0/simple_statistics.min.js"></script>
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://d3js.org/d3-drag.v1.min.js"></script>
    <script src="https://d3js.org/d3-zoom.v1.min.js"></script>

    <script>
        var width = 900,
            height = 600
            scale0 = (width - 1) / 2 / Math.PI;

        var svg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(d3.behavior.zoom().on("zoom", function () {
            svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
            }))
            .append("g")


        var projection = d3.geoRobinson()
            .center([4, 0.0])
            .scale(180)
            .translate([width / 2, height / 2]);

        var geoPath = d3.geo.path()
            .projection(projection);

        queue()
            .defer(d3.json, "data/countries_geo.json")
            .defer(d3.csv, "data/mil_xpnd.csv")
            .defer(d3.csv, "data/decade_of_terrorism.csv")
            .await(makeMap);

        function makeMap(error, countries, perOfGdp, attacks) {

            var dataArray = []; // empty array

            // loop through each country
            perOfGdp.forEach(function(country) {
                // loop through each country's properties
                for(var key in country) {
                    // if the property value is a number and not null
                    if(Number(key) && country[key] != 'null'){
                        // push to the array
                        dataArray.push(country[key]);
                    }

                }

            });

            console.log(dataArray) // dataArray with only numbers

            var breaks = ss.jenks(dataArray, 5); // the breaks

            breaks.shift();
            breaks.pop();

            var colors = ["#feedde", "#fdbe85", "#fd8d3c", "#e6550d", "#a63603"];

            // loop through all the countries
            countries.features.map(function(country) {

                // shortcut for the country id
                var countryId = country.id;

                // loop through the CSV data array
                perOfGdp.map(function(countryData) {

                    // if country code id and CSV code match
                    if (countryId === countryData['country_code']) {

                        // replace country props with CSV data
                        country.properties = countryData
                    }

                })

            })

            var min = 1996,
                max = 2006;

            var jenks = d3.scale.threshold()
                .domain(breaks)
                .range(colors);

            // var currentYear = [];
            // attacks.properties.year(function(attacks) {
            //     var attackYear = attacks.properties.year
            //     currentYear.push(attackYear)
            // });

            var gdp = svg.append("g")
                .selectAll("path")
                .data(countries.features)
                .enter()
                .append("path")
                .attr("d", geoPath)
                .attr("class", "countries")
                .attr("fill", function(d) {
                    return jenks(d.properties['1996']);
                    console.log(d)
                })
                .on("mouseover", function(d) {
                    d3.select("h2").html(d.properties.country + ': ' +
                        "<br/>" + Math.round(d.properties['1996']) + '% ' + 'of GDP');
                    d3.select(this).attr("class", "countries hover");
                })
                .on("mouseout", function(d) {
                    d3.select("h2").text("");
                    d3.select(this).attr("class", "countries");
                })

            var terrorInc = svg.append("g")
                .selectAll("circle")
                .data(attacks)
                .enter()
                .append("circle")
                .attr("cx", function(d) {
                    d.position = projection([d.lon, d.lat])
                    return d.position[0];
                })
                .attr("cy", function(d) {
                    return d.position[1];
                })
                .attr("r", 1 )
                .attr("d", geoPath)
                .attr("class", "attack");



            var output = d3.select("#year").text(min);

            d3.select(".slider")
                .attr("min", min)
                .attr("max", max)
                .attr("value", min)
                .attr("step", "1")
                .on("input", function() {
                    update(this.value)
                    updateOne(this.value);
                });

            function update(val) {
                output.text(Number(val).toLocaleString());
                terrorInc.attr("display", function(d) {
                    if (val == Number(d.year)) {
                        return "none";
                    }
                })

            }

            function updateOne(val){
               output.text(Number(val).toLocaleString());
               gdp.attr("display",function(d) {
                   if (val <= Number(d.properties['1996'])){
                       return "none";
                   }
               })
           }

            d3.entries(attacks)

            var counts = d3.nest()
                .key(function(d) {
                    return d.year;
                })
                .sortKeys(d3.ascending)
                .key(function(d) {
                    return d.country_ids;
                })
                .sortKeys(d3.alphabetically)
                .rollup(function(leaves) {
                    return leaves.length;
                })
                .entries(attacks);
            console.log(counts)

        } // end of makeMap()
    </script>
</body>

</html>
